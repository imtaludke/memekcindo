---
// src/pages/index.astro
import Layout from '../layouts/BaseLayout.astro';
import VideoCard from '../components/VideoCard.astro';
import { slugify } from '../utils/slugify';
import { getAllVideos, type VideoData } from '../utils/data';

// --- Pertahankan import dari site.ts ---
import { nama, desk, url, terbit } from '../utils/site.ts'; 
// --- Akhir import site.ts ---

export const prerender = true;

const allVideos: VideoData[] = await getAllVideos();

const videosByCategory: { [key: string]: VideoData[] } = {};
const numberOfVideosPerCategory = 16; // Jumlah video acak yang ingin ditampilkan per kategori

const usedTitlesForCategories = new Set<string>(); // Melacak judul video yang sudah ditampilkan di kategori

// Mengelompokkan dan memilih video untuk setiap kategori
allVideos.forEach(video => {
  if (!videosByCategory[video.category]) {
    videosByCategory[video.category] = [];
  }
  videosByCategory[video.category].push(video);
});

const finalVideosByCategory: { [key: string]: VideoData[] } = {};
const allCategoryNames = Object.keys(videosByCategory);

allCategoryNames.forEach(categoryName => {
  const videosInThisCategory = videosByCategory[categoryName];

  // Acak video di dalam kategori ini untuk mendapatkan pilihan yang acak
  const shuffledVideosInThisCategory = videosInThisCategory
    .sort(() => 0.5 - Math.random());

  const selectedVideosForCategory: VideoData[] = [];

  // Iterasi melalui video yang diacak dan tambahkan hanya yang judulnya unik
  for (const video of shuffledVideosInThisCategory) {
    const normalizedTitle = video.title.toLowerCase().trim();
    if (!usedTitlesForCategories.has(normalizedTitle)) {
      selectedVideosForCategory.push(video);
      usedTitlesForCategories.add(normalizedTitle); // Tambahkan judul ke set yang sudah digunakan
    }
    if (selectedVideosForCategory.length >= numberOfVideosPerCategory) {
      break; // Hentikan jika sudah mencapai batas per kategori
    }
  }
  finalVideosByCategory[categoryName] = selectedVideosForCategory;
});

const sortedCategories = Object.keys(finalVideosByCategory).sort(); // Urutkan kategori secara alfabetis

// --- Logika untuk Bagian "Video Pilihan" (Random Videos) - TANPA PAGINASI ---
const videosForRandomSelection = allVideos.filter(video => {
  const normalizedTitle = video.title.toLowerCase().trim();
  // Filter video yang judulnya BELUM terpakai di bagian kategori
  return !usedTitlesForCategories.has(normalizedTitle);
});

// Acak semua video yang tersisa untuk bagian "Video Pilihan"
const shuffledRandomVideos = videosForRandomSelection
  .sort(() => 0.5 - Math.random());

// Batasi jumlah video acak yang ditampilkan di halaman utama (opsional, disarankan jika video banyak)
const maxRandomVideosToShow = 32; // Tampilkan maksimal 32 video acak di bagian ini
const allRandomVideos = shuffledRandomVideos.slice(0, maxRandomVideosToShow);
// --- Akhir Logika Tanpa Paginasi ---

// Mengumpulkan semua domain untuk preconnect (optimasi performa)
const allDomains = new Set<string>();

// Mengiterasi video di bagian "Video Pilihan" (sekarang semua video random yang dibatasi)
allRandomVideos.forEach(video => {
  try {
    if (video.embedUrl) allDomains.add(new URL(video.embedUrl).origin);
  } catch (e) {
    console.error(`[ERROR] URL embed tidak valid untuk video ID ${video.id} (allRandomVideos):`, e);
  }
});

// Mengiterasi video di setiap kategori
Object.values(finalVideosByCategory).flat().forEach(video => {
  try {
    if (video.embedUrl) allDomains.add(new URL(video.embedUrl).origin);
  } catch (e) {
    console.error(`[ERROR] URL embed tidak valid untuk video ID ${video.id} (finalVideosByCategory):`, e);
  }
});

const preconnectDomains = Array.from(allDomains); // Ubah Set menjadi Array untuk props

// Breadcrumbs untuk skema markup (JSON-LD)
const breadcrumbs = [
  { name: 'Home', url: `${url}` }, // Menggunakan 'url' dari site.ts
];

// Variabel untuk Layout props diambil dari site.ts
const currentUrl = url;
const siteName = nama;
const siteDescription = desk;
const sitePublishedDate = terbit; // Menggunakan 'terbit' dari site.ts
---

<Layout
  title={`${siteName} - Video Bokep Indo Terbaru`}
  description={siteDescription}
  preconnectDomains={preconnectDomains}
  siteName={siteName}
  siteUrl={currentUrl}
>

  <main class="home-page" itemscope itemtype="http://schema.org/WebPage">
    <meta itemprop="url" content={currentUrl} />
    <meta itemprop="name" content={`${siteName} - Video Bokep Indo Terbaru`} />
    <meta itemprop="description" content={siteDescription} />
    <div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content={siteName} />
      <div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
        <meta itemprop="url" content={`${currentUrl}/logo.png`} />
      </div>
    </div>
    <meta itemprop="datePublished" content={sitePublishedDate}/>
    <meta itemprop="dateModified" content={new Date().toISOString()} />

    <section class="hero-section">
      <h1 itemprop="headline">Selamat Datang di {siteName}!</h1>
      <p itemprop="description">{siteDescription} Tonton Sekarang Juga!</p>
    </section>

    {/* Bagian "Video Pilihan" (Sekarang tanpa Paginasi dan terbatas) */}
    <section class="random-videos-section">
      {allRandomVideos.length > 0 ? (
        <>
          <h2 class="section-title">Video Pilihan</h2>
          <div class="video-grid">
            {allRandomVideos.map((video) => (
              <VideoCard video={video} videoDetailPath={`/${slugify(video.title)}-${video.id}`} />
            ))}
          </div>
          {/* Tidak ada lagi navigasi paginasi di sini */}
        </>
      ) : (
        <p class="no-videos">Tidak ada video pilihan yang ditemukan saat ini.</p>
      )}
    </section>

    {/* Bagian Kategori (tidak berubah, tetap tanpa paginasi di index) */}
    <section class="all-categories-section">
      {sortedCategories.length === 0 ? (
        <p class="no-videos-overall">Belum ada video yang tersedia di portal ini.</p>
      ) : (
        sortedCategories.map(categoryName => (
          <div class="category-group">
            <h2 class="category-title">
              {categoryName}
            </h2>
            <div class="video-grid">
              {finalVideosByCategory[categoryName].length === 0 ? (
                <p class="no-videos-in-category">Tidak ada video dalam kategori ini.</p>
              ) : (
                finalVideosByCategory[categoryName].map((video) => (
                  <VideoCard video={video} videoDetailPath={`/${slugify(video.title)}-${video.id}`} />
                ))
              )}
            </div>
            {/* Tombol "Lihat Semua" untuk kategori, masih menunjuk ke halaman paginasi kategori */}
            {videosByCategory[categoryName] && videosByCategory[categoryName].length > numberOfVideosPerCategory && (
              <div class="view-all-button-container">
                <a href={`${url}/category/${slugify(categoryName)}/1`} class="view-all-button">Lihat Semua di kategori {categoryName}</a>
              </div>
            )}
          </div>
        ))
      )}
    </section>

  </main>
</Layout>
