---
import Layout from '../layouts/BaseLayout.astro';
import VideoCard from '../components/VideoCard.astro';
import { slugify } from '../utils/slugify';
import { nama, url, terbit } from '../utils/site.ts';
import type { VideoData } from '../utils/data';

import fs from 'node:fs';
import path from 'node:path';

export const prerender = true;

export async function getStaticPaths() {
  const filePath = path.resolve(process.cwd(), 'public', 'processedVideos.json');
  const fileContent = fs.readFileSync(filePath, 'utf-8');
  const allVideos: VideoData[] = JSON.parse(fileContent) as VideoData[];

  return allVideos.map(video => ({
    params: { slug: `${slugify(video.title)}-${video.id}` },
    props: { video, allVideos },
  }));
}

const { video, allVideos } = Astro.props;

const numberOfRelatedVideos = 16;
let relatedVideos: VideoData[] = [];

const currentVideoTitleKeywords = video.title
  .toLowerCase()
  .split(/\s+/)
  .filter(word => word.length > 2 && !['bokep', 'video', 'jepang', 'indo', 'yang', 'dan', 'di', 'ini', 'itu', 'dengan'].includes(word));

const candidateVideos = allVideos.filter(v =>
    v.id !== video.id &&
    v.title.toLowerCase() !== video.title.toLowerCase()
);

const scoredCandidates = candidateVideos.map(v => {
  let score = 0;
  const otherVideoTitle = v.title.toLowerCase();

  if (v.category === video.category) {
    score += 100;
  }

  currentVideoTitleKeywords.forEach(keyword => {
    if (otherVideoTitle.includes(keyword)) {
      score += 5;
    }
  });

  return { video: v, score };
});

scoredCandidates.sort((a, b) => {
  if (b.score === a.score) {
    return 0.5 - Math.random();
  }
  return b.score - a.score;
});

const addedVideoIds = new Set<string>();
const addedVideoTitles = new Set<string>();

for (const scoredV of scoredCandidates) {
  if (relatedVideos.length >= numberOfRelatedVideos) {
    break;
  }
  const lowerCaseTitle = scoredV.video.title.toLowerCase();
  if (!addedVideoIds.has(scoredV.video.id) && !addedVideoTitles.has(lowerCaseTitle)) {
    relatedVideos.push(scoredV.video);
    addedVideoIds.add(scoredV.video.id);
    addedVideoTitles.add(lowerCaseTitle);
  }
}

if (relatedVideos.length < numberOfRelatedVideos) {
  const remainingSlots = numberOfRelatedVideos - relatedVideos.length;
  const otherVideosForRandom = allVideos.filter(v =>
    v.id !== video.id &&
    v.title.toLowerCase() !== video.title.toLowerCase() &&
    !addedVideoIds.has(v.id) &&
    !addedVideoTitles.has(v.title.toLowerCase())
  );
  const shuffledOthersForRandom = otherVideosForRandom.sort(() => 0.5 - Math.random());
  relatedVideos.push(...shuffledOthersForRandom.slice(0, remainingSlots));
}

const numberOfRandomVideos = 16;
const currentAndRelatedVideoIds = new Set([video.id, ...relatedVideos.map(v => v.id)]);
const currentAndRelatedVideoTitles = new Set([video.title.toLowerCase(), ...relatedVideos.map(v => v.title.toLowerCase())]);

const videosForRandomSelection = allVideos.filter(v =>
    !currentAndRelatedVideoIds.has(v.id) &&
    !currentAndRelatedVideoTitles.has(v.title.toLowerCase())
);

const randomVideos = videosForRandomSelection
  .sort(() => 0.5 - Math.random())
  .slice(0, numberOfRandomVideos);

const allDomains = new Set<string>();
try {
  if (video.embedUrl) allDomains.add(new URL(video.embedUrl).origin);
} catch (e) {
  console.error(`URL embed video tidak valid untuk video ID ${video.id} (current video):`, e);
}

relatedVideos.forEach(v => {
  try {
    if (v.embedUrl) allDomains.add(new URL(v.embedUrl).origin);
  } catch (e) {
    console.error(`URL embed video tidak valid untuk video ID ${v.id} (related video):`, e);
  }
});

randomVideos.forEach(v => {
  try {
    if (v.embedUrl) allDomains.add(new URL(v.embedUrl).origin);
  } catch (e) {
    console.error(`URL embed video tidak valid untuk video ID ${v.id} (random video):`, e);
  }
});

const preconnectDomains = Array.from(allDomains);

const breadcrumbs = [
  { name: 'Home', url: `${url}` },
  { name: video.category, url: `${url}/category/${slugify(video.category)}/1` },
  { name: video.title },
];

const datePublished = video.datePublished || terbit;
const dateModified = video.dateModified || new Date().toISOString();

const schemaWebPage = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "url": `${url}/${slugify(video.title)}-${video.id}/`,
  "name": `${video.title}`,
  "description": `${video.description} di ${nama}`,
  "publisher": {
    "@type": "Organization",
    "name": nama,
    "logo": {
      "@type": "ImageObject",
      "url": `${url}/logo.png`
    }
  },
  "datePublished": datePublished,
  "dateModified": dateModified
};

const schemaVideoObject = {
  "@context": "https://schema.org",
  "@type": "VideoObject",
  "name": video.title,
  "description": `${video.description} di ${nama}`,
  "uploadDate": datePublished,
  "embedUrl": video.embedUrl,
  "thumbnailUrl": `${url}${video.thumbnail}`,
  "publisher": {
    "@type": "Organization",
    "name": nama,
    "logo": {
      "@type": "ImageObject",
      "url": `${url}/logo.png`
    }
  },
};

const schemaBreadcrumb = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": breadcrumbs.map((item, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "name": item.name,
    ...(item.url && { "item": item.url })
  }))
};

const videoTags = typeof video.tags === 'string' && video.tags.length > 0
  ? video.tags.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0)
  : [];
---

<Layout
  title={`${video.title} - ${nama}`}
  description={`${video.description} di ${nama}`}
  preconnectDomains={preconnectDomains}
  siteName={nama}
  siteUrl={url}
>
  <script type="application/ld+json" set:html={JSON.stringify(schemaWebPage)} />
  <script type="application/ld+json" set:html={JSON.stringify(schemaVideoObject)} />
  <script type="application/ld+json" set:html={JSON.stringify(schemaBreadcrumb)} />

  <main class="video-detail-page">
    <nav class="breadcrumb" aria-label="breadcrumb">
      <ol>
        {breadcrumbs.map((item, index) => (
          <li>
            {index > 0 && <span class="separator">/</span>}
            {item.url ? (
              <a href={item.url}>
                <span>{item.name}</span>
              </a>
            ) : (
              <span>{item.name}</span>
            )}
          </li>
        ))}
      </ol>
    </nav>

    <div class="video-player-container">
      <iframe
        src={video.embedUrl}
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen
        loading="eager"
        width="100%"
        height="300"
        title={video.title}
      ></iframe>
    </div>
    <h1 class="video-title">{video.title}</h1>

    <script type="text/javascript" src="https://js.juicyads.com/jp.php?c=947403z2v256s2x2w2e4z2e4&u=https%3A%2F%2Fwww.juicyads.rocks"></script>
    <script type="text/javascript"> var juicy_tags = ['a', 'img']; </script>
    <script type="text/javascript" src="https://js.juicyads.com/jp.php?c=947403z2v256s2x2w2e4z2e4&u=https%3A%2F%2Fwww.juicyads.rocks"></script>
    <div class="juicyads-ad-container" style="min-height: 300px; width: 100%; display: flex; justify-content: center; align-items: center; background-color: var(--card-bg); border-radius: var(--border-radius-medium); margin-bottom: var(--spacing-unit);">
      <ins id="1055940" data-width="308" data-height="298"></ins>
      <script type="text/javascript" data-cfasync="false" async>(adsbyjuicy = window.adsbyjuicy || []).push({'adzone':1055940});</script>
    </div>

    <p class="video-description">{video.description}</p>

    {videoTags.length > 0 && (
      <section class="video-tags-section">
        <h2 class="section-title">Tags:</h2>
        <div class="tags-list">
          {videoTags.map(tag => (
            <a href={`/video/${slugify(tag)}/1`} class="tag-chip">
              {tag}
            </a>
          ))}
        </div>
      </section>
    )}

    {relatedVideos.length > 0 && (
      <section class="related-videos-section">
        <h2 class="section-title">Video Terkait {video.title}</h2>
        <div class="video-grid">
          {relatedVideos.map((relatedVideo) => (
            <VideoCard video={relatedVideo} videoDetailPath={`/${slugify(relatedVideo.title)}-${relatedVideo.id}/`} headingLevel="h3" />
          ))}
        </div>
      </section>
    )}

    {randomVideos.length > 0 && (
      <section class="random-videos-section">
        <div class="juicyads-ad-container" style="min-height: 300px; width: 100%; display: flex; justify-content: center; align-items: center; background-color: var(--card-bg); border-radius: var(--border-radius-medium); margin-bottom: var(--spacing-unit);">
          <script type="text/javascript" data-cfasync="false" async src="https://poweredby.jads.co/js/jads.js"></script>
          <ins id="1055940" data-width="308" data-height="298"></ins>
          <script type="text/javascript" data-cfasync="false" async>(adsbyjuicy = window.adsbyjuicy || []).push({'adzone':1055940});</script>
        </div>
        <h2 class="section-title">Rekomendasi Video Lainnya</h2>
        <div class="video-grid">
          {randomVideos.map((randomVideo) => (
            <VideoCard video={randomVideo} videoDetailPath={`/${slugify(randomVideo.title)}-${randomVideo.id}/`} headingLevel="h3" />
          ))}
        </div>
      </section>
    )}
  </main>
</Layout>

<style>
  .video-tags-section {
    margin-top: calc(var(--spacing-unit) * 1.5);
    margin-bottom: calc(var(--spacing-unit) * 1.5);
    padding: var(--spacing-unit);
    background-color: var(--background-color-card);
    border-radius: var(--border-radius-medium);
    border: 1px solid var(--border-color);
  }

  .video-tags-section .section-title {
    font-size: 1.2em;
    margin-bottom: var(--spacing-unit-small);
    color: var(--text-color);
  }

  .tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: calc(var(--spacing-unit) / 2);
  }

  .tag-chip {
    display: inline-block;
    background-color: var(--primary-color-light);
    color: var(--primary-color-dark);
    padding: 0.4em 0.8em;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9em;
    transition: background-color 0.2s ease, transform 0.2s ease;
    border: 1px solid var(--primary-color-dark);
  }

  .tag-chip:hover {
    background-color: var(--primary-color);
    color: white;
    transform: translateY(-1px);
    box-shadow: var(--shadow-light);
  }

  .video-detail-page {
    max-width: var(--max-width-content);
    margin: 0 auto;
    padding: var(--spacing-unit);
  }

  .breadcrumb {
    margin-bottom: var(--spacing-unit);
  }

  .breadcrumb ol {
    display: flex;
    flex-wrap: wrap;
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 0.9em;
  }

  .breadcrumb li {
    display: flex;
    align-items: center;
  }

  .breadcrumb a {
    color: var(--link-color);
    text-decoration: none;
  }

  .breadcrumb a:hover {
    text-decoration: underline;
  }

  .breadcrumb .separator {
    margin: 0 0.5em;
    color: var(--text-color-light);
  }

  .video-player-container {
    position: relative;
    padding-bottom: 56.25%;
    height: 0;
    overflow: hidden;
    margin-bottom: var(--spacing-unit);
    border-radius: var(--border-radius-medium);
    box-shadow: var(--shadow-medium);
  }

  .video-player-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: var(--border-radius-medium);
  }

  .video-title {
    font-size: 2em;
    color: var(--heading-color);
    margin-bottom: var(--spacing-unit-small);
    text-align: center;
  }

  .video-description {
    font-size: 1em;
    line-height: 1.6;
    color: var(--text-color);
    margin-bottom: calc(var(--spacing-unit) * 1.5);
    background-color: var(--background-color-card);
    padding: var(--spacing-unit);
    border-radius: var(--border-radius-medium);
    border: 1px solid var(--border-color);
  }

  .juicyads-ad-container {
    margin-bottom: var(--spacing-unit);
  }

  .section-title {
    font-size: 1.5em;
    color: var(--heading-color);
    margin-top: calc(var(--spacing-unit) * 2);
    margin-bottom: var(--spacing-unit);
    text-align: center;
  }

  .video-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: var(--spacing-unit);
  }
</style>
