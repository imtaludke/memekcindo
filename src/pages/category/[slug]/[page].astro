---
import Layout from '../../../layouts/BaseLayout.astro';
import VideoCard from '../../../components/VideoCard.astro';
import { slugify } from '../../../utils/slugify';
import { nama, url } from '../../../utils/site.ts';
import type { VideoData } from '../../../utils/data.ts';

export const prerender = true;

import processedVideosJson from '../../../../public/processedVideos.json';
const allVideos: VideoData[] = processedVideosJson as VideoData[];

const videosPerPage = 40;

export async function getStaticPaths() {
  const allVideosForPaths: VideoData[] = (await import('../../../../public/processedVideos.json')).default as VideoData[];
  const VIDEOS_PER_PAGE_FOR_PATHS = 40;

  const categoryData: { [key: string]: number } = {};
  allVideosForPaths.forEach(video => {
    if (!categoryData[video.category]) {
      categoryData[video.category] = 0;
    }
    categoryData[video.category]++;
  });

  const paths = Object.keys(categoryData).flatMap(categoryName => {
    const totalVideosInCategory = categoryData[categoryName];
    const totalPagesInCategory = Math.ceil(totalVideosInCategory / VIDEOS_PER_PAGE_FOR_PATHS);
    const categorySlug = slugify(categoryName);

    return Array.from({ length: totalPagesInCategory }, (_, i) => ({
      params: { slug: categorySlug, page: (i + 1).toString() },
      props: { categoryName: categoryName }
    }));
  });

  return paths;
}

const { slug, page } = Astro.params;
const currentPage = parseInt(page as string);
const { categoryName } = Astro.props;

const categoryVideos = allVideos.filter(video => slugify(video.category) === slug);

const sortedCategoryVideos = [...categoryVideos].sort((a, b) => a.title.localeCompare(b.title));

const startIndex = (currentPage - 1) * videosPerPage;
const endIndex = startIndex + videosPerPage;
const paginatedVideos = sortedCategoryVideos.slice(startIndex, endIndex);

const totalVideosInCategory = sortedCategoryVideos.length;
const totalPagesInCategory = Math.ceil(totalVideosInCategory / videosPerPage);

const preconnectDomains = new Set<string>();
paginatedVideos.forEach(video => {
  try {
    if (video.embedUrl) {
      preconnectDomains.add(new URL(video.embedUrl).origin);
    }
  } catch (e) {
    console.error(`Invalid URL for video ID "${video.id}" (category page):`, e);
  }
});
const currentUrl = import.meta.env.PUBLIC_SITE_URL;

const pageCanonicalUrl = new URL(Astro.url.pathname, url).href;

const breadcrumbs = [
  { name: 'Home', url: `${currentUrl}` },
  { name: 'Category', url: `${currentUrl}/category/` },
  { name: `${categoryName} Page ${currentPage}` },
];
---

<Layout
  title={`${categoryName} Videos (Page ${currentPage}) | ${nama}`}
  description={`Halaman ${currentPage} dari video kategori ${categoryName} di ${nama}.`}
  preconnectDomains={Array.from(preconnectDomains)}
  canonicalUrl={pageCanonicalUrl}
>
  <main class="category-page" itemscope itemtype="http://schema.org/CollectionPage">
    <nav class="breadcrumb" aria-label="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList">
      <ol>
        {breadcrumbs.map((item, index) => (
          <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            {index > 0 && <span class="separator">/</span>}
            {item.url ? (
              <a itemprop="item" href={item.url}>
                <span itemprop="name">{item.name}</span>
              </a>
            ) : (
              <span itemprop="name">{item.name}</span>
            )}
            <meta itemprop="position" content={(index + 1).toString()} />
          </li>
        ))}
      </ol>
    </nav>

    <h1 class="page-title" itemprop="headline">Video Kategori: {categoryName} (Halaman {currentPage})</h1>
    <p class="page-description">Menampilkan {paginatedVideos.length} dari {totalVideosInCategory} video.</p>

    {paginatedVideos.length === 0 ? (
      <p class="no-videos">Tidak ada video di kategori ini untuk halaman ini.</p>
    ) : (
      <div class="video-grid">
        {paginatedVideos.map((video) => (
          <VideoCard video={video} videoDetailPath={`/${slugify(video.title)}-${video.id}`} />
        ))}
      </div>
    )}

    {totalPagesInCategory > 1 && (
      <nav class="pagination" aria-label={`Navigasi Kategori ${categoryName}`}>
        {currentPage > 1 && (
          <a
            href={`${currentUrl}/category/${slug}/${currentPage - 1}`}
            class="pagination-link pagination-prev"
            rel="prev"
          >
            &laquo; Sebelumnya
          </a>
        )}
        {Array.from({ length: totalPagesInCategory }, (_, i) => (
          <a
            key={i + 1}
            href={`${currentUrl}/category/${slug}/${i + 1}`}
            class={`pagination-link ${currentPage === i + 1 ? 'active' : ''}`}
            aria-current={currentPage === i + 1 ? 'page' : undefined}
          >
            {i + 1}
          </a>
        ))}
        {currentPage < totalPagesInCategory && (
          <a
            href={`${currentUrl}/category/${slug}/${currentPage + 1}`}
            class="pagination-link pagination-next"
            rel="next"
          >
            Berikutnya &raquo;
          </a>
        )}
      </nav>
    )}
  </main>
</Layout>
